name: Build Module

on:
  workflow_dispatch:
    inputs:
      major:
        type: number
        description: 'Major version increment by? (e.g. 1)'
        default: 0
        required: true
      minor:
        type: number
        description: 'Minor version increment by? (e.g. 1)'
        default: 1
        required: true

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - uses: Yakov5776/gh-apkmirror-dl@v1.3
        with:
          org: 'google-inc'
          repo: 'youtube'
          version: '20.13.41'
          bundle: false
          filename: 'com.google.android.youtube.apk'

      - name: Move APK to module/base
        run: |
          mkdir  -p ./module/base/
          mkdir  -p ./module/apk/
          mv ./com.google.android.youtube.apk ./module/base/

      - name: Generate Patched Youtube APK
        run: |
          shopt -s nullglob
          patch_files=( *.rvp )
          rvx_cli=( *.jar )
          base_apk=( /module/base/*.apk )
          
          if [ ${#patch_files[@]} -eq 0 ]; then
            echo "Error: No .rvp patch file found." >&2
            exit 1
          fi
          if [ ${#rvx_cli[@]} -eq 0 ]; then
            echo "Error: No .jar CLI file found." >&2
            exit 1
          fi
          if [ ${#base_apk[@]} -eq 0 ]; then
            echo "Error: No base APK found in /module/base/." >&2
            exit 1
          fi
          
          patch_file="${patch_files[0]}"
          cli_jar="${rvx_cli[0]}"
          apk_file="${base_apk[0]}"
          
          echo "Using patch file: $patch_file"
          java -jar "$cli_jar" patch -p "$patch_file" -o "./module/base/apk" -t "./temp" --purge --signer ${{ env.REPO_OWNER }} "$apk_file"

      - name: Create module zip
        working-directory: ./module
        run: |
          MODULE_NAME="Revanced-YT-For-SUSFS"
          zip -r "../$MODULE_NAME.zip" . -x "*.git*" -x ".github/*" -x "*.yml" -x "README.md"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: module-zip
          path: "*.zip"